name: elastic_search_ha_proxy

services:
  # =========================
  # MASTER NODES (dedicated)
  # =========================
  master-1:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.12.2
    container_name: master-1
    restart: unless-stopped
    environment:
      # --- Required identity / cluster ---
      - cluster.name=es-ha
      - node.name=master-1
      - node.roles=master

      # --- Discovery / cluster formation ---
      - discovery.seed_hosts=master-1,master-2,master-3
      # CHỈ dùng lúc bootstrap lần đầu, sau đó bỏ đi
      - cluster.initial_master_nodes=master-1,master-2,master-3

      # --- Network (khuyên set rõ) ---
      - network.host=0.0.0.0
      - http.port=9200
      - transport.port=9300

      # --- Memory / runtime ---
      - bootstrap.memory_lock=true
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
      - node.store.allow_mmap=false

      # --- Security (lab only) ---
      - xpack.security.enabled=false
      - xpack.security.http.ssl.enabled=false
      - xpack.security.transport.ssl.enabled=false

    ulimits:
      memlock: { soft: -1, hard: -1 }
      nofile:  { soft: 65535, hard: 65535 }
    volumes:
      - master1-data:/usr/share/elasticsearch/data
    networks: [ esnet ]

  master-2:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.12.2
    container_name: master-2
    restart: unless-stopped
    environment:
      - cluster.name=es-ha
      - node.name=master-2
      - node.roles=master

      - discovery.seed_hosts=master-1,master-2,master-3
      - cluster.initial_master_nodes=master-1,master-2,master-3

      - network.host=0.0.0.0
      - http.port=9200
      - transport.port=9300

      - bootstrap.memory_lock=true
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
      - node.store.allow_mmap=false

      - xpack.security.enabled=false
      - xpack.security.http.ssl.enabled=false
      - xpack.security.transport.ssl.enabled=false

    ulimits:
      memlock: { soft: -1, hard: -1 }
      nofile:  { soft: 65535, hard: 65535 }
    volumes:
      - master2-data:/usr/share/elasticsearch/data
    networks: [ esnet ]

  master-3:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.12.2
    container_name: master-3
    restart: unless-stopped
    environment:
      - cluster.name=es-ha
      - node.name=master-3
      - node.roles=master

      - discovery.seed_hosts=master-1,master-2,master-3
      - cluster.initial_master_nodes=master-1,master-2,master-3

      - network.host=0.0.0.0
      - http.port=9200
      - transport.port=9300

      - bootstrap.memory_lock=true
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
      - node.store.allow_mmap=false

      - xpack.security.enabled=false
      - xpack.security.http.ssl.enabled=false
      - xpack.security.transport.ssl.enabled=false

    ulimits:
      memlock: { soft: -1, hard: -1 }
      nofile:  { soft: 65535, hard: 65535 }
    volumes:
      - master3-data:/usr/share/elasticsearch/data
    networks: [ esnet ]

  # =========================
  # DATA NODES
  # =========================
  data-1:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.12.2
    container_name: data-1
    restart: unless-stopped
    environment:
      - cluster.name=es-ha
      - node.name=data-1
      - node.roles=data,ingest

      - discovery.seed_hosts=master-1,master-2,master-3

      - network.host=0.0.0.0
      - http.port=9200
      - transport.port=9300

      - bootstrap.memory_lock=true
      - ES_JAVA_OPTS=-Xms768m -Xmx768m
      - node.store.allow_mmap=false

      - xpack.security.enabled=false
      - xpack.security.http.ssl.enabled=false
      - xpack.security.transport.ssl.enabled=false

    ulimits:
      memlock: { soft: -1, hard: -1 }
      nofile:  { soft: 65535, hard: 65535 }
    volumes:
      - data1-data:/usr/share/elasticsearch/data
    networks: [ esnet ]

  data-2:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.12.2
    container_name: data-2
    restart: unless-stopped
    environment:
      - cluster.name=es-ha
      - node.name=data-2
      - node.roles=data,ingest

      - discovery.seed_hosts=master-1,master-2,master-3

      - network.host=0.0.0.0
      - http.port=9200
      - transport.port=9300

      - bootstrap.memory_lock=true
      - ES_JAVA_OPTS=-Xms768m -Xmx768m
      - node.store.allow_mmap=false

      - xpack.security.enabled=false
      - xpack.security.http.ssl.enabled=false
      - xpack.security.transport.ssl.enabled=false

    ulimits:
      memlock: { soft: -1, hard: -1 }
      nofile:  { soft: 65535, hard: 65535 }
    volumes:
      - data2-data:/usr/share/elasticsearch/data
    networks: [ esnet ]

  data-3:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.12.2
    container_name: data-3
    restart: unless-stopped
    environment:
      - cluster.name=es-ha
      - node.name=data-3
      - node.roles=data,ingest

      - discovery.seed_hosts=master-1,master-2,master-3

      - network.host=0.0.0.0
      - http.port=9200
      - transport.port=9300

      - bootstrap.memory_lock=true
      - ES_JAVA_OPTS=-Xms768m -Xmx768m
      - node.store.allow_mmap=false

      - xpack.security.enabled=false
      - xpack.security.http.ssl.enabled=false
      - xpack.security.transport.ssl.enabled=false

    ulimits:
      memlock: { soft: -1, hard: -1 }
      nofile:  { soft: 65535, hard: 65535 }
    volumes:
      - data3-data:/usr/share/elasticsearch/data
    networks: [ esnet ]

  # =========================
  # COORDINATING-ONLY NODES
  # =========================
  coord-1:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.12.2
    container_name: coord-1
    restart: unless-stopped
    environment:
      - cluster.name=es-ha
      - node.name=coord-1
      - node.roles=[]

      - discovery.seed_hosts=master-1,master-2,master-3

      - network.host=0.0.0.0
      - http.port=9200
      - transport.port=9300

      - bootstrap.memory_lock=true
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
      - node.store.allow_mmap=false

      - xpack.security.enabled=false
      - xpack.security.http.ssl.enabled=false
      - xpack.security.transport.ssl.enabled=false

    ulimits:
      memlock: { soft: -1, hard: -1 }
      nofile:  { soft: 65535, hard: 65535 }
    # coord-only thường không cần volume data, nhưng có thể thêm nếu bạn muốn giữ state local
    networks: [ esnet ]

  coord-2:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.12.2
    container_name: coord-2
    restart: unless-stopped
    environment:
      - cluster.name=es-ha
      - node.name=coord-2
      - node.roles=[]

      - discovery.seed_hosts=master-1,master-2,master-3

      - network.host=0.0.0.0
      - http.port=9200
      - transport.port=9300

      - bootstrap.memory_lock=true
      - ES_JAVA_OPTS=-Xms512m -Xmx512m
      - node.store.allow_mmap=false

      - xpack.security.enabled=false
      - xpack.security.http.ssl.enabled=false
      - xpack.security.transport.ssl.enabled=false

    ulimits:
      memlock: { soft: -1, hard: -1 }
      nofile:  { soft: 65535, hard: 65535 }
    networks: [ esnet ]

  # =========================
  # HAPROXY #1
  # =========================
  haproxy-1:
    image: haproxy:2.9
    container_name: haproxy-1
    restart: unless-stopped
    ports:
      - "19200:9200"
    volumes:
      - ./haproxy/haproxy-1.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    depends_on:
      - coord-1
      - coord-2
    networks: [ esnet ]

  # =========================
  # HAPROXY #2
  # =========================
  haproxy-2:
    image: haproxy:2.9
    container_name: haproxy-2
    restart: unless-stopped
    ports:
      - "19201:9200"
    volumes:
      - ./haproxy/haproxy-2.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    depends_on:
      - coord-1
      - coord-2
    networks: [ esnet ]

  # =========================
  # KIBANA
  # =========================
  kibana:
    image: docker.elastic.co/kibana/kibana:8.12.2
    container_name: kibana
    restart: unless-stopped
    environment:
      - SERVER_NAME=kibana
      # dùng cả 2 HAProxy để tăng availability phía client entrypoint
      - ELASTICSEARCH_HOSTS=["http://haproxy-1:9200","http://haproxy-2:9200"]
      - XPACK_SECURITY_ENABLED=false
    ports:
      - "15601:5601"
    depends_on:
      - haproxy-1
      - haproxy-2
    networks: [ esnet ]

networks:
  esnet:
    driver: bridge

volumes:
  master1-data:
  master2-data:
  master3-data:
  data1-data:
  data2-data:
  data3-data: