docker-compose.yml

name: elastic_search_ha_proxy

services:
  setup-certs:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.12.2
    container_name: setup-certs
    user: "0"
    restart: "no"
    command: |
      bash -c '
        set -euo pipefail
        CERTS_DIR=/usr/share/elasticsearch/config/certs
        CA_ZIP="$$CERTS_DIR/ca.zip"
        CERTS_ZIP="$$CERTS_DIR/certs.zip"

        mkdir -p "$$CERTS_DIR"
        cd "$$CERTS_DIR"

        # cleanup zip rác từ lần chạy fail trước (nếu có)
        rm -f "$$CA_ZIP" "$$CERTS_ZIP"

        if [ ! -f ca/ca.crt ]; then
          echo "[setup-certs] Generating CA..."
          mkdir -p ca

          /usr/share/elasticsearch/bin/elasticsearch-certutil ca \
            --silent --pem \
            -out "$$CA_ZIP"

          test -f "$$CA_ZIP"
          unzip -o "$$CA_ZIP" -d ca_tmp
          cp ca_tmp/ca/ca.crt ca/ca.crt
          cp ca_tmp/ca/ca.key ca/ca.key
          rm -rf ca_tmp "$$CA_ZIP"
        else
          echo "[setup-certs] CA already exists, skipping."
        fi

        if [ ! -f master-1/master-1.crt ]; then
          echo "[setup-certs] Generating node certs from /tmp/instances.yml ..."

          /usr/share/elasticsearch/bin/elasticsearch-certutil cert \
            --silent --pem \
            --in /tmp/instances.yml \
            --ca-cert "$$CERTS_DIR/ca/ca.crt" \
            --ca-key "$$CERTS_DIR/ca/ca.key" \
            -out "$$CERTS_ZIP"

          test -f "$$CERTS_ZIP"
          unzip -o "$$CERTS_ZIP" -d .
          rm -f "$$CERTS_ZIP"
        else
          echo "[setup-certs] Node certs already exist, skipping."
        fi

        chown -R 1000:0 "$$CERTS_DIR"
        find "$$CERTS_DIR" -type d -exec chmod 750 {} \;
        find "$$CERTS_DIR" -type f -exec chmod 640 {} \;

        echo "[setup-certs] Done."
      '
    volumes:
      - certs:/usr/share/elasticsearch/config/certs
      - ./certs/instances.yml:/tmp/instances.yml:ro
    networks: [ esnet ]

  setup-passwords:
    image: curlimages/curl:8.6.0
    container_name: setup-passwords
    user: "0"
    restart: "no"
    depends_on:
      setup-certs:
        condition: service_completed_successfully
      coord-1:
        condition: service_started
    environment:
      ELASTIC_PASSWORD: ${ELASTIC_PASSWORD}
      KIBANA_SYSTEM_PASSWORD: ${KIBANA_SYSTEM_PASSWORD}
    volumes:
      - certs:/certs:ro
    command: >
      sh -c '
        set -eu

        echo "[setup-passwords] Waiting for Elasticsearch via coord-1..."
        until curl -sS --cacert /certs/ca/ca.crt \
          -u elastic:"$$ELASTIC_PASSWORD" \
          https://coord-1:9200/_security/_authenticate >/dev/null; do
          echo "[setup-passwords] ES not ready yet..."
          sleep 5
        done

        echo "[setup-passwords] Setting kibana_system password..."
        curl -sS --fail --cacert /certs/ca/ca.crt \
          -u elastic:"$$ELASTIC_PASSWORD" \
          -H "Content-Type: application/json" \
          -X POST https://coord-1:9200/_security/user/kibana_system/_password \
          -d "{\"password\":\"$$KIBANA_SYSTEM_PASSWORD\"}"

        echo
        echo "[setup-passwords] Done."
      '
    networks: [ esnet ]

  # =========================
  # MASTER NODES
  # =========================
  master-1:
    extends:
      file: ./compose.templates.yml
      service: es-master-template
    container_name: master-1
    environment:
      node.name: master-1
      cluster.initial_master_nodes: master-1,master-2,master-3
      xpack.security.transport.ssl.certificate: /usr/share/elasticsearch/config/certs/master-1/master-1.crt
      xpack.security.transport.ssl.key: /usr/share/elasticsearch/config/certs/master-1/master-1.key
      xpack.security.http.ssl.certificate: /usr/share/elasticsearch/config/certs/master-1/master-1.crt
      xpack.security.http.ssl.key: /usr/share/elasticsearch/config/certs/master-1/master-1.key
    volumes:
      - master1-data:/usr/share/elasticsearch/data
      - certs:/usr/share/elasticsearch/config/certs:ro
    networks: [ esnet ]

  master-2:
    extends:
      file: ./compose.templates.yml
      service: es-master-template
    container_name: master-2
    environment:
      node.name: master-2
      cluster.initial_master_nodes: master-1,master-2,master-3
      xpack.security.transport.ssl.certificate: /usr/share/elasticsearch/config/certs/master-2/master-2.crt
      xpack.security.transport.ssl.key: /usr/share/elasticsearch/config/certs/master-2/master-2.key
      xpack.security.http.ssl.certificate: /usr/share/elasticsearch/config/certs/master-2/master-2.crt
      xpack.security.http.ssl.key: /usr/share/elasticsearch/config/certs/master-2/master-2.key
    volumes:
      - master2-data:/usr/share/elasticsearch/data
      - certs:/usr/share/elasticsearch/config/certs:ro
    networks: [ esnet ]

  master-3:
    extends:
      file: ./compose.templates.yml
      service: es-master-template
    container_name: master-3
    environment:
      node.name: master-3
      cluster.initial_master_nodes: master-1,master-2,master-3
      xpack.security.transport.ssl.certificate: /usr/share/elasticsearch/config/certs/master-3/master-3.crt
      xpack.security.transport.ssl.key: /usr/share/elasticsearch/config/certs/master-3/master-3.key
      xpack.security.http.ssl.certificate: /usr/share/elasticsearch/config/certs/master-3/master-3.crt
      xpack.security.http.ssl.key: /usr/share/elasticsearch/config/certs/master-3/master-3.key
    volumes:
      - master3-data:/usr/share/elasticsearch/data
      - certs:/usr/share/elasticsearch/config/certs:ro
    networks: [ esnet ]

  # =========================
  # DATA NODES
  # =========================
  data-1:
    extends:
      file: ./compose.templates.yml
      service: es-data-template
    container_name: data-1
    environment:
      node.name: data-1
      xpack.security.transport.ssl.certificate: /usr/share/elasticsearch/config/certs/data-1/data-1.crt
      xpack.security.transport.ssl.key: /usr/share/elasticsearch/config/certs/data-1/data-1.key
      xpack.security.http.ssl.certificate: /usr/share/elasticsearch/config/certs/data-1/data-1.crt
      xpack.security.http.ssl.key: /usr/share/elasticsearch/config/certs/data-1/data-1.key
    volumes:
      - data1-data:/usr/share/elasticsearch/data
      - certs:/usr/share/elasticsearch/config/certs:ro
    networks: [ esnet ]

  data-2:
    extends:
      file: ./compose.templates.yml
      service: es-data-template
    container_name: data-2
    environment:
      node.name: data-2
      xpack.security.transport.ssl.certificate: /usr/share/elasticsearch/config/certs/data-2/data-2.crt
      xpack.security.transport.ssl.key: /usr/share/elasticsearch/config/certs/data-2/data-2.key
      xpack.security.http.ssl.certificate: /usr/share/elasticsearch/config/certs/data-2/data-2.crt
      xpack.security.http.ssl.key: /usr/share/elasticsearch/config/certs/data-2/data-2.key
    volumes:
      - data2-data:/usr/share/elasticsearch/data
      - certs:/usr/share/elasticsearch/config/certs:ro
    networks: [ esnet ]

  data-3:
    extends:
      file: ./compose.templates.yml
      service: es-data-template
    container_name: data-3
    environment:
      node.name: data-3
      xpack.security.transport.ssl.certificate: /usr/share/elasticsearch/config/certs/data-3/data-3.crt
      xpack.security.transport.ssl.key: /usr/share/elasticsearch/config/certs/data-3/data-3.key
      xpack.security.http.ssl.certificate: /usr/share/elasticsearch/config/certs/data-3/data-3.crt
      xpack.security.http.ssl.key: /usr/share/elasticsearch/config/certs/data-3/data-3.key
    volumes:
      - data3-data:/usr/share/elasticsearch/data
      - certs:/usr/share/elasticsearch/config/certs:ro
    networks: [ esnet ]

  # =========================
  # COORDINATING-ONLY NODES
  # =========================
  coord-1:
    extends:
      file: ./compose.templates.yml
      service: es-coord-template
    container_name: coord-1
    environment:
      node.name: coord-1
      xpack.security.transport.ssl.certificate: /usr/share/elasticsearch/config/certs/coord-1/coord-1.crt
      xpack.security.transport.ssl.key: /usr/share/elasticsearch/config/certs/coord-1/coord-1.key
      xpack.security.http.ssl.certificate: /usr/share/elasticsearch/config/certs/coord-1/coord-1.crt
      xpack.security.http.ssl.key: /usr/share/elasticsearch/config/certs/coord-1/coord-1.key
    volumes:
      - certs:/usr/share/elasticsearch/config/certs:ro
    networks: [ esnet ]

  coord-2:
    extends:
      file: ./compose.templates.yml
      service: es-coord-template
    container_name: coord-2
    environment:
      node.name: coord-2
      xpack.security.transport.ssl.certificate: /usr/share/elasticsearch/config/certs/coord-2/coord-2.crt
      xpack.security.transport.ssl.key: /usr/share/elasticsearch/config/certs/coord-2/coord-2.key
      xpack.security.http.ssl.certificate: /usr/share/elasticsearch/config/certs/coord-2/coord-2.crt
      xpack.security.http.ssl.key: /usr/share/elasticsearch/config/certs/coord-2/coord-2.key
    volumes:
      - certs:/usr/share/elasticsearch/config/certs:ro
    networks: [ esnet ]

  # =========================
  # HAPROXY #1
  # =========================
  haproxy-1:
    image: haproxy:2.9
    container_name: haproxy-1
    restart: unless-stopped
    ports:
      - "29200:9200"
      - "18404:8404"
    volumes:
      - ./haproxy/haproxy-1.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    depends_on:
      - coord-1
      - coord-2
    healthcheck:
      test: ["CMD-SHELL", "haproxy -c -f /usr/local/etc/haproxy/haproxy.cfg || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 10
    networks: [ esnet ]

  # =========================
  # HAPROXY #2
  # =========================
  haproxy-2:
    image: haproxy:2.9
    container_name: haproxy-2
    restart: unless-stopped
    ports:
      - "29201:9200"
      - "18405:8404"
    volumes:
      - ./haproxy/haproxy-2.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    depends_on:
      - coord-1
      - coord-2
    healthcheck:
      test: ["CMD-SHELL", "haproxy -c -f /usr/local/etc/haproxy/haproxy.cfg || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 10
    networks: [ esnet ]

  # =========================
  # KIBANA
  # =========================
  kibana:
    image: docker.elastic.co/kibana/kibana:8.12.2
    container_name: kibana
    restart: unless-stopped
    depends_on:
      setup-passwords:
        condition: service_completed_successfully
      haproxy-1:
        condition: service_started
      haproxy-2:
        condition: service_started
    environment:
      SERVER_NAME: kibana
      ELASTICSEARCH_HOSTS: '["https://haproxy-1:9200","https://haproxy-2:9200"]'
      ELASTICSEARCH_USERNAME: kibana_system
      ELASTICSEARCH_PASSWORD: ${KIBANA_SYSTEM_PASSWORD}
      ELASTICSEARCH_SSL_CERTIFICATEAUTHORITIES: /usr/share/kibana/config/certs/ca/ca.crt
      ELASTICSEARCH_SSL_VERIFICATIONMODE: certificate
      XPACK_SECURITY_ENABLED: "true"

      # Kibana UI HTTPS
      SERVER_SSL_ENABLED: "true"
      SERVER_SSL_CERTIFICATE: /usr/share/kibana/config/certs/kibana/kibana.crt
      SERVER_SSL_KEY: /usr/share/kibana/config/certs/kibana/kibana.key

      XPACK_SECURITY_ENCRYPTIONKEY: ${KIBANA_SECURITY_ENCRYPTION_KEY}
      XPACK_ENCRYPTEDSAVEDOBJECTS_ENCRYPTIONKEY: ${KIBANA_ENCRYPTED_SAVED_OBJECTS_KEY}
      XPACK_REPORTING_ENCRYPTIONKEY: ${KIBANA_REPORTING_ENCRYPTION_KEY}

      XPACK_REPORTING_ROLES_ENABLED: "false"
    volumes:
      - certs:/usr/share/kibana/config/certs:ro
    ports:
      - "15601:5601"
    healthcheck:
      test: [ "CMD-SHELL", "curl -sk https://localhost:5601/login >/dev/null || exit 1" ]
      interval: 20s
      timeout: 5s
      retries: 20
      start_period: 60s
    networks: [ esnet ]

  # =========================
  # ESRALLY
  # =========================
  rally:
    image: python:3.11
    container_name: es-rally
    restart: unless-stopped
    working_dir: /work
    entrypoint: ["/bin/sh", "/work/rally-entrypoint.sh"]
    tty: true
    stdin_open: true
    environment:
      GIT_TERMINAL_PROMPT: "0"
      PIP_DISABLE_PIP_VERSION_CHECK: "1"
    volumes:
      - rally-data:/root/.rally
      - ./rally-work:/work
      - certs:/certs:ro
      - ./scripts:/scripts:ro
    depends_on:
      - haproxy-1
      - haproxy-2
    networks: [ esnet ]

  toolbox:
    image: alpine:3.20
    container_name: es-toolbox
    command: >
      sh -c "
      apk add --no-cache curl jq openssl bash apache2-utils &&
      tail -f /dev/null
      "
    volumes:
      - certs:/certs:ro
      - ./scripts:/scripts
    networks: [ esnet ]
    depends_on:
      - haproxy-1
      - haproxy-2

networks:
  esnet:
    driver: bridge

volumes:
  master1-data:
  master2-data:
  master3-data:
  data1-data:
  data2-data:
  data3-data:
  certs:
  rally-data:

compose.templates.yml
name: elastic_search_templates

services:
  # =========================
  # TEMPLATE: common ES base
  # =========================
  es-common:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.12.2
    restart: unless-stopped
    depends_on:
      setup-certs:
        condition: service_completed_successfully
    ulimits:
      memlock: { soft: -1, hard: -1 }
      nofile: { soft: 65535, hard: 65535 }
    networks: [ esnet ]
    environment:
      cluster.name: es-ha
      discovery.seed_hosts: master-1,master-2,master-3
      network.host: 0.0.0.0
      http.port: "9200"
      transport.port: "9300"
      bootstrap.memory_lock: "true"
      node.store.allow_mmap: "false"

      # Security + TLS
      xpack.security.enabled: "true"
      ELASTIC_PASSWORD: ${ELASTIC_PASSWORD}

      # Transport TLS
      xpack.security.transport.ssl.enabled: "true"
      xpack.security.transport.ssl.verification_mode: certificate
      xpack.security.transport.ssl.certificate_authorities: /usr/share/elasticsearch/config/certs/ca/ca.crt

      # HTTP TLS
      xpack.security.http.ssl.enabled: "true"
      xpack.security.http.ssl.certificate_authorities: /usr/share/elasticsearch/config/certs/ca/ca.crt
    volumes:
      - certs:/usr/share/elasticsearch/config/certs:ro

  # =========================
  # TEMPLATE: master node
  # =========================
  es-master-template:
    extends:
      service: es-common
    environment:
      node.roles: master
      ES_JAVA_OPTS: -Xms512m -Xmx512m
      # CHỈ bootstrap lần đầu; sau đó remove/comment ở file chính
      cluster.initial_master_nodes: master-1,master-2,master-3
    healthcheck:
      test: [ "CMD-SHELL", "curl -sk https://localhost:9200 >/dev/null || exit 1" ]
      interval: 15s
      timeout: 5s
      retries: 20
      start_period: 40s

  # =========================
  # TEMPLATE: data node
  # =========================
  es-data-template:
    extends:
      service: es-common
    environment:
      node.roles: data,ingest
      ES_JAVA_OPTS: -Xms768m -Xmx768m
    healthcheck:
      test: [ "CMD-SHELL", "curl -sk https://localhost:9200 >/dev/null || exit 1" ]
      interval: 15s
      timeout: 5s
      retries: 20
      start_period: 40s

  # =========================
  # TEMPLATE: coordinating-only node
  # =========================
  es-coord-template:
    extends:
      service: es-common
    environment:
      node.roles: "[]"
      ES_JAVA_OPTS: -Xms512m -Xmx512m
    healthcheck:
      test: [ "CMD-SHELL", "curl -sk https://localhost:9200 >/dev/null || exit 1" ]
      interval: 15s
      timeout: 5s
      retries: 20
      start_period: 40s

networks:
  esnet:
    name: esnet
    driver: bridge

volumes:
  certs:
    name: elastic_search_ha_proxy_certs

.env
ELASTIC_PASSWORD=ElasticRoot@123

KIBANA_SYSTEM_PASSWORD=KibanaSystem@123

KIBANA_SECURITY_ENCRYPTION_KEY=0123456789abcdef0123456789abcdef
KIBANA_ENCRYPTED_SAVED_OBJECTS_KEY=abcdef0123456789abcdef0123456789
KIBANA_REPORTING_ENCRYPTION_KEY=fedcba9876543210fedcba9876543210

certs/
instances.yml
instances:
  - name: master-1
    dns:
      - master-1
  - name: master-2
    dns:
      - master-2
  - name: master-3
    dns:
      - master-3
  - name: data-1
    dns:
      - data-1
  - name: data-2
    dns:
      - data-2
  - name: data-3
    dns:
      - data-3
  - name: coord-1
    dns:
      - coord-1
      - haproxy-1
      - haproxy-2
  - name: coord-2
    dns:
      - coord-2
      - haproxy-1
      - haproxy-2
  - name: kibana
    dns:
      - kibana


haproxy/
haproxy-1.cfg
global
  maxconn 40000
  log stdout format raw local0

defaults
  mode tcp
  log global
  option tcplog
  timeout connect 5s
  timeout client  5m
  timeout server  5m
  timeout check   3s

frontend es_https
  bind *:9200
  default_backend es_coord_tls

backend es_coord_tls
  balance roundrobin
  option tcp-check
  tcp-check connect port 9200
  default-server inter 2s fall 3 rise 2
  server coord1 coord-1:9200 check
  server coord2 coord-2:9200 check

listen stats
  bind *:8404
  mode http
  stats enable
  stats uri /stats
  stats refresh 5s
  stats auth admin:HaProxySystem@123


haproxy-2.cfg
global
  maxconn 40000
  log stdout format raw local0

defaults
  mode tcp
  log global
  option tcplog
  timeout connect 5s
  timeout client  5m
  timeout server  5m
  timeout check   3s

frontend es_https
  bind *:9200
  default_backend es_coord_tls

backend es_coord_tls
  balance roundrobin
  option tcp-check
  tcp-check connect port 9200
  default-server inter 2s fall 3 rise 2
  server coord1 coord-1:9200 check
  server coord2 coord-2:9200 check

listen stats
  bind *:8404
  mode http
  stats enable
  stats uri /stats
  stats refresh 5s
  stats auth admin:HaProxySystem@123


rally-work/
rally.ini
[meta]
config.version = 17

[system]
env.name = docker

[track]
repository = default

[reporting]
datastore.type = in-memory

rally-entrypoint.sh
#!/usr/bin/env sh
set -eu

echo "[rally] booting..."

apt-get update
apt-get install -y --no-install-recommends \
  git ca-certificates curl dnsutils iputils-ping jq procps
rm -rf /var/lib/apt/lists/*

git config --global http.version HTTP/1.1 || true
git config --global http.lowSpeedLimit 1 || true
git config --global http.lowSpeedTime 300 || true

python -m pip install --no-cache-dir --upgrade pip
python -m pip install --no-cache-dir esrally

echo "[rally] versions:"
git --version
curl --version | head -n 1
/usr/local/bin/esrally --version

echo "[rally] ready (sleeping)..."
tail -f /dev/null


scripts/
00_smoke.sh
#!/usr/bin/env bash
set -euo pipefail

ES_URL="${ES_URL:-https://haproxy-1:9200}"
ES_USER="${ES_USER:-elastic}"
ES_PASS="${ES_PASS:-ElasticRoot@123}"
CA_CERT="${CA_CERT:-/certs/ca/ca.crt}"

echo "[smoke] ES_URL=$ES_URL"

curl -sS --cacert "$CA_CERT" -u "$ES_USER:$ES_PASS" \
  "$ES_URL" | jq .

curl -sS --cacert "$CA_CERT" -u "$ES_USER:$ES_PASS" \
  "$ES_URL/_cluster/health?pretty" | jq .

curl -sS --cacert "$CA_CERT" -u "$ES_USER:$ES_PASS" \
  "$ES_URL/_cat/nodes?v" | sed 's/^/[nodes] /'


10_setup_index.sh
#!/usr/bin/env bash
set -euo pipefail

ES_URL="${ES_URL:-https://haproxy-1:9200}"
ES_USER="${ES_USER:-elastic}"
ES_PASS="${ES_PASS:-ElasticRoot@123}"
CA_CERT="${CA_CERT:-/certs/ca/ca.crt}"

INDEX="${INDEX:-bench_docs}"
SHARDS="${SHARDS:-3}"
REPLICAS="${REPLICAS:-1}"

echo "[setup] create index=$INDEX shards=$SHARDS replicas=$REPLICAS"

curl -sS --cacert "$CA_CERT" -u "$ES_USER:$ES_PASS" \
  -X DELETE "$ES_URL/$INDEX" >/dev/null || true

curl -sS --fail --cacert "$CA_CERT" -u "$ES_USER:$ES_PASS" \
  -H 'Content-Type: application/json' \
  -X PUT "$ES_URL/$INDEX" -d "{
    \"settings\": {
      \"number_of_shards\": $SHARDS,
      \"number_of_replicas\": $REPLICAS,
      \"refresh_interval\": \"1s\"
    },
    \"mappings\": {
      \"properties\": {
        \"ts\": {\"type\": \"date\"},
        \"user\": {\"type\": \"keyword\"},
        \"msg\": {\"type\": \"text\"},
        \"value\": {\"type\": \"double\"}
      }
    }
  }" | jq .

echo "[setup] done"

20_bulk_load.sh
#!/usr/bin/env bash
set -euo pipefail

ES_URL="${ES_URL:-https://haproxy-1:9200}"
ES_USER="${ES_USER:-elastic}"
ES_PASS="${ES_PASS:-ElasticRoot@123}"
CA_CERT="${CA_CERT:-/certs/ca/ca.crt}"

INDEX="${INDEX:-bench_docs}"

# knobs
BULK_DOCS="${BULK_DOCS:-1000}"          # docs per bulk request
BULK_ITERS="${BULK_ITERS:-50}"          # number of bulk requests
MSG_SIZE="${MSG_SIZE:-200}"             # chars in msg
SLEEP_BETWEEN="${SLEEP_BETWEEN:-0}"     # seconds

tmp="$(mktemp)"
bulk_body="$(mktemp)"

gen_msg() {
  # generate pseudo text length MSG_SIZE
  head -c "$MSG_SIZE" /dev/urandom | base64 | tr -d '\n' | head -c "$MSG_SIZE"
}

echo "[bulk] index=$INDEX docs_per_bulk=$BULK_DOCS iters=$BULK_ITERS msg_size=$MSG_SIZE"

# prepare one bulk payload template (ndjson)
: > "$bulk_body"
for i in $(seq 1 "$BULK_DOCS"); do
  echo "{\"index\":{\"_index\":\"$INDEX\"}}" >> "$bulk_body"
  m="$(gen_msg)"
  # simple doc
  echo "{\"ts\":\"$(date -Iseconds)\",\"user\":\"u$((RANDOM%100))\",\"value\":$((RANDOM%10000))/100,\"msg\":\"$m\"}" >> "$bulk_body"
done

total_docs=0
ok_reqs=0
err_reqs=0
sum_ms=0
min_ms=999999
max_ms=0
start_all=$(date +%s%3N)

for iter in $(seq 1 "$BULK_ITERS"); do
  t0=$(date +%s%3N)
  http_code=$(curl -sS -o "$tmp" -w "%{http_code}" \
    --cacert "$CA_CERT" -u "$ES_USER:$ES_PASS" \
    -H 'Content-Type: application/x-ndjson' \
    -X POST "$ES_URL/_bulk?refresh=false" \
    --data-binary @"$bulk_body" || true)
  t1=$(date +%s%3N)
  dt=$((t1-t0))

  if (( dt < min_ms )); then min_ms=$dt; fi
  if (( dt > max_ms )); then max_ms=$dt; fi
  sum_ms=$((sum_ms+dt))

  if [[ "$http_code" != "200" ]]; then
    err_reqs=$((err_reqs+1))
    echo "[bulk][$iter] HTTP $http_code dt=${dt}ms"
  else
    # check bulk errors field
    has_errors=$(jq -r '.errors' "$tmp" 2>/dev/null || echo "true")
    if [[ "$has_errors" == "true" ]]; then
      err_reqs=$((err_reqs+1))
      echo "[bulk][$iter] BULK_ERRORS dt=${dt}ms"
      jq '.items[0]' "$tmp" >/dev/null 2>&1 || true
    else
      ok_reqs=$((ok_reqs+1))
      total_docs=$((total_docs+BULK_DOCS))
      echo "[bulk][$iter] OK dt=${dt}ms"
    fi
  fi

  if [[ "$SLEEP_BETWEEN" != "0" ]]; then sleep "$SLEEP_BETWEEN"; fi
done

end_all=$(date +%s%3N)
wall_ms=$((end_all-start_all))
wall_s=$(python3 - <<PY
print(${wall_ms}/1000)
PY
)

avg_ms=$(python3 - <<PY
ok=${ok_reqs}+${err_reqs}
print(round(${sum_ms}/max(ok,1),2))
PY
)

docs_per_s=$(python3 - <<PY
docs=${total_docs}
sec=${wall_ms}/1000
print(round(docs/max(sec,0.001),2))
PY
)

echo
echo "===== BULK SUMMARY ====="
echo "total_docs=$total_docs"
echo "requests_ok=$ok_reqs requests_err=$err_reqs"
echo "latency_ms avg=$avg_ms min=$min_ms max=$max_ms"
echo "wall_s=$wall_s docs_per_s=$docs_per_s"
echo "========================"

30_search_warmup.sh
#!/usr/bin/env bash
set -euo pipefail

ES_URL="${ES_URL:-https://haproxy-1:9200}"
ES_USER="${ES_USER:-elastic}"
ES_PASS="${ES_PASS:-ElasticRoot@123}"
CA_CERT="${CA_CERT:-/certs/ca/ca.crt}"
INDEX="${INDEX:-bench_docs}"

curl -sS --cacert "$CA_CERT" -u "$ES_USER:$ES_PASS" \
  -H 'Content-Type: application/json' \
  -X POST "$ES_URL/$INDEX/_search" -d '{
    "size": 10,
    "query": {"match": {"msg": "a"}}
  }' >/dev/null

echo "[warmup] done"

31_ab_search.sh
#!/usr/bin/env bash
set -euo pipefail

HOST="${HOST:-haproxy-1}"
PORT="${PORT:-9200}"
INDEX="${INDEX:-bench_docs}"
ES_USER="${ES_USER:-elastic}"
ES_PASS="${ES_PASS:-ElasticRoot@123}"

N="${N:-20000}"
C="${C:-200}"
KEEPALIVE="${KEEPALIVE:-true}"
TIMEOUT="${TIMEOUT:-120}"     # NEW
VERBOSE="${VERBOSE:-0}"       # NEW (0/1)

auth="$(printf "%s:%s" "$ES_USER" "$ES_PASS" | base64 -w0)"

cat > /tmp/search.json <<'JSON'
{"size":10,"track_total_hits":false,"query":{"match":{"msg":"a"}}}
JSON

ka_flag=""
[[ "$KEEPALIVE" == "true" ]] && ka_flag="-k"

v_flag=""
[[ "$VERBOSE" == "1" ]] && v_flag="-v 2"

echo "[ab] N=$N C=$C timeout=${TIMEOUT}s keepalive=$KEEPALIVE target=https://$HOST:$PORT/$INDEX/_search"

ab $v_flag $ka_flag -s "$TIMEOUT" -n "$N" -c "$C" \
  -T "application/json" \
  -H "Authorization: Basic $auth" \
  -p /tmp/search.json \
  "https://$HOST:$PORT/$INDEX/_search"

40_collect_metrics.sh
#!/usr/bin/env bash
set -euo pipefail

ES_URL="${ES_URL:-https://haproxy-1:9200}"
ES_USER="${ES_USER:-elastic}"
ES_PASS="${ES_PASS:-ElasticRoot@123}"
CA_CERT="${CA_CERT:-/certs/ca/ca.crt}"
OUT_DIR="${OUT_DIR:-/tmp/es-metrics}"

mkdir -p "$OUT_DIR"
ts="$(date +%F_%H%M%S)"

req() {
  local path="$1"
  local out="$2"
  curl -sS --cacert "$CA_CERT" -u "$ES_USER:$ES_PASS" \
    "$ES_URL$path" > "$out"
  echo "[metrics] wrote $out"
}

req "/_cluster/health"            "$OUT_DIR/${ts}_health.json"
req "/_cat/nodes?v&h=name,ip,role,heap.percent,ram.percent,cpu,load_1m,master" "$OUT_DIR/${ts}_nodes.txt"
req "/_nodes/stats/jvm,process,os,thread_pool,fs,indices" "$OUT_DIR/${ts}_nodes_stats.json"
req "/_stats?pretty"              "$OUT_DIR/${ts}_indices_stats.json"
req "/_cat/thread_pool?v"         "$OUT_DIR/${ts}_thread_pool.txt"
req "/_cat/shards?v"              "$OUT_DIR/${ts}_shards.txt"

echo "[metrics] all done -> $OUT_DIR"

